datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["interactiveTransactions"]
}

enum Status {
  PROCESSED
  PROCESSING
  OUTDATED
  UNPROCESSED
}

enum Availability {
  AVAILABLE
  UNAVAILABLE
  PENDING
}

model User {
  id               String                  @id @default(cuid())
  email            String                  @unique
  spotifyUserId    String                  @unique
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  trackRating      TrackRating[]
  favorites        Favorite[]
  youtubeChannels  UserOnYoutubeChannel[]
  youtubePlaylists UserOnYoutubePlaylist[]
  spotifyPlaylists SpotifyPlaylist[]
  playlistOffset   Int                     @default(0)
  totalPlaylists   Int                     @default(0)
}

model SpotifyPlaylist {
  id         String  @id @default(cuid())
  name       String
  user       User    @relation(fields: [userId], references: [id])
  userId     String
  playlistId String  @unique
  image      String?
  url        String

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lastViewedAt DateTime @default(now())
}

model Favorite {
  id            String         @id @default(cuid())
  userId        String?        @unique
  youtubeVideos YoutubeVideo[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  user          User?          @relation(fields: [userId], references: [id])
}

model YoutubePlaylist {
  id            String                  @id @default(cuid())
  title         String
  playlistId    String                  @unique
  spotifyTracks SpotifyTrack[]
  pages         YoutubePlaylistPage[]
  image         String?
  trackCount    Int
  youtubeVideos YoutubeVideo[]
  users         UserOnYoutubePlaylist[]
  status        Status                  @default(UNPROCESSED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model YoutubePlaylistPage {
  id                String           @id @default(cuid())
  pageToken         String           @unique
  pageNumber        Int              @unique
  youtubePlaylist   YoutubePlaylist? @relation(fields: [youtubePlaylistId], references: [id])
  youtubePlaylistId String?
  youtubeVideos     YoutubeVideo[]
}

model YoutubeChannel {
  id            String                 @id @default(cuid())
  title         String
  channelId     String                 @unique
  spotifyTracks SpotifyTrack[]
  image         String?
  totalVideos   Int
  youtubeVideos YoutubeVideo[]
  users         UserOnYoutubeChannel[]
  status        Status                 @default(UNPROCESSED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserOnYoutubeChannel {
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  userId           String         @unique
  user             User           @relation(fields: [userId], references: [id])
  youtubeChannelId String
  youtubeChannel   YoutubeChannel @relation(fields: [youtubeChannelId], references: [id])
  isFavorite       Boolean        @default(false)
  lastViewedAt     DateTime?      @default(now())


  @@id([userId, youtubeChannelId])
}

model UserOnYoutubePlaylist {
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  userId            String          @unique
  user              User            @relation(fields: [userId], references: [id])
  youtubePlaylistId String
  youtubePlaylist   YoutubePlaylist @relation(fields: [youtubePlaylistId], references: [id])
  isFavorite        Boolean         @default(false)
  lastViewedAt      DateTime?       @default(now())

  @@id([userId, youtubePlaylistId])
}

model TrackRating {
  id             String        @id @default(cuid())
  rating         Int
  user           User          @relation(fields: [userId], references: [id])
  userId         String
  youtubeVideoId String?
  youtubeVideo   YoutubeVideo? @relation(fields: [youtubeVideoId], references: [id])
  serviceTrackId String // i.e. youtubeVideoId || NTS trackId 
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model YoutubeVideo {
  id                    String               @id @default(cuid())
  title                 String
  channelId             String
  youtubeVideoId        String               @unique
  spotifyTracks         SpotifyTrack[]
  availability          Availability
  trackRating           TrackRating[]
  favorite              Favorite?            @relation(fields: [favoriteId], references: [id])
  favoriteId            String?
  youtubeChannel        YoutubeChannel?      @relation(fields: [youtubeChannelId], references: [id])
  youtubeChannelId      String?
  youtubePlaylists      YoutubePlaylist[]
  YoutubePlaylistPage   YoutubePlaylistPage? @relation(fields: [youtubePlaylistPageId], references: [id])
  youtubePlaylistPageId String?
}

model SpotifyTrack {
  id               String            @id @default(cuid())
  trackId          String?           @unique
  searchQuery      String
  youtubeVideoId   String?
  youtubeVideo     YoutubeVideo?     @relation(fields: [youtubeVideoId], references: [id])
  images           Json?
  artists          Json?
  name             String
  trackUrl         String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  levenshteinScore Int?
  availability     Availability      @default(PENDING) // FIX: REMOVE Availability
  youtubeChannels  YoutubeChannel[]
  youtubePlaylists YoutubePlaylist[]
}
